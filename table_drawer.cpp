#include <assert.h>
#include <string.h>
#include <iostream>
#include <math.h>
#include <stdio.h>      /* printf, scanf, puts, NULL */
#include <time.h> 
#include <stdlib.h>
#include <bitset>
#include <vector>
#include <stdint.h>
#include <unordered_set>
#include <queue>
#include "countpatterns.h"
using namespace std;

uint64_t run_experiment(string set, int n) {
  return run_interior_experiment(set, n);
  // return n;
}

uint64_t Catalan(uint64_t n) {
  assert (n > 0);
  uint64_t Catalans[] = {1, 1, 2, 5, 14, 42, 132, 429, 1430, 4862, 16796, 58786, 208012, 742900, 2674440, 9694845, 35357670, 129644790, 477638700, 1767263190, 6564120420, 24466267020, 91482563640, 343059613650, 1289904147324};
  assert(n < sizeof(Catalans));
  return Catalans[n];
}

uint64_t choose(uint64_t tmpn, uint64_t tmpk) {
  uint64_t n = tmpn - tmpk + 1;
  uint64_t k = tmpk + 1;
  // cout<<tmpn<<" "<<tmpk<<endl;
  uint64_t array[n][k];
  for (int i = 0; i < n; i++) array[i][0] = 1;
  for (int j = 0; j < k; j++) array[0][j] = 1;
  for (int i = 1; i < n; i++) {
    for (int j = 1; j < k; j++) {
      array[i][j] = array[i-1][j] + array[i][j-1];
    }
  }
  return array[n-1][k-1];
}

uint64_t factorial(int n) {
  double answer = 1;
  for (int i = 1; i <= n; i++) answer *= i;
  return answer;
}


double allestimatedseqcheck(int k, int n) {
  double bottom = 0;
  for (int i = 1; i <= k - 3; i++) {
    bottom += choose(n - k + i, i);
  }
  bottom += (((double)factorial(k -  1) - (double)1) / factorial(k - 1)) * (double) choose(n - 2, k - 2);
  return bottom;
}

double singleestimatedseqcheck(int k, int n) {
  double bottom = 0;
  for (int i = 1; i <= k - 2; i++) {
    bottom += (((double)1) / factorial(i + 1)) * choose(n - k + i, i);
  }
  return bottom;
}

double brutesingleestimatedseqcheck(int k, int n) {
  double bottom = 0;
  for (int i = 1; i <= k - 1; i++) {
    bottom += (((double)1) / factorial(i - 1)) * choose(n - k + i, i);
  }
  return bottom;
}

double buildspecialratio(int k, int n, double runtime, double prevruntime) {
  uint64_t bottom = 0;
  for (int i = 1; i <= k - 3; i++) {
    bottom += choose(n - k + i, i);
  }
  bottom *= Catalan(n);
  double real_bottom = (double)bottom + (double)Catalan(n) * ((factorial(k -  1) - (double)1) / factorial(k - 1)) * (double) choose(n - 2, k - 2);
  return (runtime - prevruntime) / real_bottom;
}

template <typename T>
void buildtable(int startk, int startn, int endk, int endn, vector < vector < T > > array) {
    cout<<"\\begin{tabular}{l |";
  for (int k = startk; k <= endk; k++) {
    cout<<" l ";
  }
  cout<<"}"<<endl;
  for (int k = startk; k <= endk; k++) {
    cout<<" & ";
    cout<<k;
  }
  cout<<" \\\\ \\hline"<<endl;
  for (int n = startn; n <= endn; n++) {
    cout<<n;
    for (int k = startk; k <= endk; k++) {
      cout<<" & "<<array[k][n];
    }
    cout<<" \\\\"<<endl;
  }
  cout<<"\\end{tabular}"<<endl;
}

int main() {
  //string sets[] = {"123", "1234", "12345", "123456"};
  // string sets[] = {"1234 1324 2314 2134 3124 3214"};   // an example where eqspec underestimates --> conjecture becomes does there exist a constant depending on the set s.t. eqspec will always be within that constant. and then say that for all computations above, eqspec stayed within a factor of two correct. in fact, it only fell below ?? for the 231 computation. so it seems likely that it's off by a lot only in special cases; even in thsoe cases i personally supect that it's no off by enough to show up prominantly in the time growth (for example it's not here i don't think).
  // string sets[] = {"4321 4231 2431 2341 3241 3421"};  // an example where eqspec does well (or maybe overestimates?)
  //string sets[] = {"1324, 4231"};
  string sets[] = {"312", "2431", "24531", "246531"}; // looking at how they compare to equation eqspec, these may be better to use for experimental data
  // either are interesting in that eqspec is doing worse as n increases and is doing badly for small kl but not so badly that anything seem's likely to every be off by more than a factor of 2, at least if you look at this example above.
  // HINGS TO THINK ABOUT:
  // (1) WHY DOES 312 ALWAYS GET EQSPEC RATION 2/3?!
  // (2) MAYBE JUST USE 231 INSTEAD OF 123 CASE, SINCE WE CAN USE T TO EXPLAIN THE PHENOMENON BUT IT'S A BETTE REPRESENTATIVE OF EVERYTING ELESE
  // AND SHOWS AN EXAMPLE WHERE THE EQSPEC RATIO STARTS TO RISE AGAIN ONCE N AND K ARE LARGE ENOUGH
  // (3) THE K = 4 CASE FOR 231 DOES SO POORLY BECAUSE EVEN THOUGH 231-AVOIDING PERMUTATIONS ARE BIAS TOWARDS HAVING FEWER INVERSIONS, WHEN N-1 AND N ARE IN ORDER IT MAKES A 231 HIT ALMOST INEVITABLE, RESULTING IN THEM ALMOST ALWAYS BEING OUT OF ORDER; THUS WE BASICALLY DO NOT GET THE 12 PREFIX, UNLIKE AS ANTICIPATED BY EQSPEC.
  // (4) WHY DOES EQSPEC RATIO TEND TO DECREASE? FOR A GOOD EXAMPLE OF THIS, THINK OF THE 231 CASE, WHERE THE 12 PREFIX ONLY SHOWS UP WHEN N IS AT THE END. THIS CASE GETS RARER AND RARE OVER TIME AS THERE ARE MORE AND MORE PLACES FOR N TO BE THAT AREN'T THE END. PROBABLY A SIMILAR THING TENDS TO HAPPEN IN GENERAL WHERE PREFIXES WHICH DON'T SHOW UP MUCH SHOW UP A LITTLE BY HAVING PARTS OF THEM BE AT THE ENDS OF THE PERMUTATION, BUT THEIR FREQUENCIES FALL OVER TIME, LEADING TO EQUATION EQSPEC BECOMING SLIGHTLY LESS ACCURATE OVER TIME. CLEARLY THIS IS NOT ALWAYS THE CASE, FOR EXAMPLE IN OUR EXPERIMENT WITH LARGE SETS OF PATTERNS.
  // (5) SHOULD BE BE CONCERNED THAT EQSPEC IS OFF BY NEARLY 40% IN SOME CASES? WELL FOR LARGE K, IT SEEMS TO DO PRETTY WELL. THERE ARE NO CASES RECORDED WHERE IT'S OFF BY MORE THAN 50% (FOR V2; CASES DO EXIST FOR NAIVE, BUT WHO CARES SINCE NAIVE SUCKS). SO IT SEEMS AS THOUGH I SHOULD NOT BE CONCERNED, JUST INTERESTED.
  // (6) BE HAPPY: WE HAVE A BETTER STORY TO TELL FOR THE LARGE SET CASE (BECAUSE IT IS MORE CONSISE AND EASIER TO UNDERSTAND NOW -- MORE FOCUSED).
  //  (7) FOR THE SINGLE PATTERN CASE, WE COULD TALKA BOUT THE EQSPECS, BUT IT'S PROBABLY NOT WORTH IT. IT SEEMS TO BE FALLING A LITTLE FASTER THOUGH THAN I WOULD HAVE EXPECTED, BUT I STILL DOUBT ANY OF THEME VERY GO BELOW 50%. HMM. ON THE OTHER HAND, WE DON'T MAKE ANY CLAIMS ABOUT EQSPEC FOR THAT CASE, OR TALK ABOUT IT AT ALL -- HOWEVER, WE DO MENTION THAT EQSPEC CAN BE INACCURATE,ONE ALTERNATIVE, IS SINCE WE DONT UNERSTAND EQSPEC'S ACCURACY VERY WELL IN GENERAL, IS TO ONLY MENTION IT BRIEFLY EVERYWHERE. RATHER THAN HAVE A WHOLE TABLE FO IT FOR THE 231-EXTENED CASE, WE COULD JUST MENTION THAT IT IS BETWEEN 50 AND 60 PERCENT FOR 132, BUT THAT THIS IS NO LONGER TRUE FOR LARGER K, WHEN FOR OUR COMPUTATIONS IT IS IN RANGES ???? RESPECTIVELY. COULD DO A SIMILAR GAME TO SAVE TABLE SPACE FOR PERCENT OF COMPUTATION TAKEN UP BY NON-AVOIDERS. THEN FOR THE SINGLETON CASE, SINCE WE'RE NOT MAKING ANY AUDATIOUS CLAIMS ABOUT OUR RELATIVE PERFORMANCE IN PRACTICE, IT'S PROBABLY NOT DISCUSSING SOMETHING THAT ONLY SEEMS TO AFFECT PERFORMANCE BY LESS THAN 50% (IN ALL CASES WE HAVE SEEN, INCLUDING USING SETS OF DIFFERENT SIZES); BUT IT IS WORTH POSING AS AN OPEN PROBLEM TO BETTER UNDESTAND EQSPEC'S ACCURACY, WITH THE RELATED CONJECTURE THAT EQSPEC IS ALWAYS CORRECT UP TO A CONSTANT (WE COULD EVEN MENTION THAT WE HAVEN'T SEEN ANY CASES WHERE IT'S OFF BY MORE THAN 50% FOR PERMLAB'S ALGORITHM).  SO EVEN IF EQSPEC ENDS UP BEING OFF BY A NON-CONSTANT AMOUNT, IT SEEMS AS THOUGH BY THAT POINT THE OTHER ASYMPTOTICS WOULD BE QUITE SIGNIFICANT RELATIVE TO THAT AMOUNT. SO ALTHOUGH I'M INTERESTED IN THE STUDY OF EQSPEC, IT SEEMS TO BE OK-ACCURACY, I TREAT IT SO FAR AS THAT I CONJECTURE THE BEHAVIOR OF IT'S ACCURACY, BUT I DO NOT GO TOO FAR INTO DETAIL ABOUT IT BECAUSE FOR OUR COMPUTATIONS IT DIDN'T AFFECT THINGS VERY MUCHFOR ANY SET OF PATTERNS WE'VE SEEN. CONSEQUENTLY, TALKING A LOT ABOUT IT WOULD BE LESS RELAVENT THAN DISCUSSING CACHE BEHAVIOR IN DETAIL.
  // (8) MAYBE USE THE NON-IDENTITY ONES FOR SINGLE PATTERNS, SINCE WE ANALYZED IDENTITY WELL ALREADY FOR OUR ALGORITHM
  // (10) A sentence like: There may be sets of patterns where the innacuracy is not as static when $n$ changes. The most significant example in the computations here is ???, where the ratio of the correct answer to eqs?? changes by ?? percent between n = ?? and n = ??. In fact, the accuracy of ?? is not very well understood at all, and warents future work. For example, is it true that ?? -- we've seen no computations obviously contradicting this.
  
  // string sets[] = {"231",
  //  		   "3421 2314 4231 2431 3241 3412 3142 1342 2413 2341 ",
  //  		   "41352 32514 45231 42153 32451 25314 35421 52314 23154 53421 34215 15342 45213 23415 42315 41253 13542 23145 45321 24153 14253 42351 43521 25143 34512 34152 53142 24531 25134 24351 54231 24135 23541 13452 45123 34251 45132 52431 21453 14523 41532 43512 35124 23514 42531 14352 35412 23451 24513 13524 42513 25413 13425 35241 31542 43152 34125 35142 32541 35214 12453 25431 52341 53241 45312 52413 25341 51342 32415 34521 31452 31524 43251 53412 31425 14532 24315 41523 ",
  //  		   "625143 341625 435216 235146 256143 563412 265413 645231 253416 516432 154632 453162 356412 623514 541263 523614 236154 531264 561243 235416 524613 623415 615342 634215 631524 312564 143562 641532 514263 653142 425361 624153 632451 136524 534162 152634 341265 265314 264153 351246 354621 264135 234651 342165 342651 356214 235461 625413 413652 453261 142563 532641 345162 561432 321564 562134 516324 451623 324516 143625 241653 235164 326145 243561 263514 356421 126453 521364 642153 541632 431562 124635 163452 652413 124653 426315 412653 316245 231456 326451 354612 652341 564321 124563 123564 413526 125634 514632 635412 365412 263154 361245 153642 634512 416532 461532 635214 234165 356241 345621 642351 514362 253146 453621 624315 532164 235641 314625 316254 462135 351462 564213 364251 152643 635124 524631 342615 314265 143526 643251 124536 254613 125643 635142 354261 234561 142536 325146 324651 156234 463215 234156 341562 236415 526341 534216 324156 254361 625341 562314 354216 164523 634125 416235 246153 431526 643152 136425 612453 512643 514623 465321 261435 426351 231564 452136 534126 451362 146532 326415 145326 146523 516243 436251 425631 341526 564123 361425 341652 135642 241635 245631 623154 563214 164352 435612 134265 154623 351642 412635 653421 314256 125364 653241 426153 523416 613524 516342 163524 451263 362541 231546 361524 246351 631452 631425 164532 463152 341256 542613 541623 356142 625431 564231 654231 325461 316542 543261 421635 456213 542316 423561 231465 134652 435621 346251 246513 365421 251643 142635 325614 526134 361254 461235 546321 415623 431625 425136 146352 364512 346152 436521 253641 215463 354162 265134 125463 562143 564132 213564 561342 346521 523641 645312 145236 134562 413625 461325 562413 526314 541362 215634 351264 264351 563421 546231 635241 135426 513624 245163 645132 254631 416253 365142 361542 241536 641253 316524 536142 416523 432615 641352 652314 264513 215364 516423 246315 542163 245316 625134 316452 315624 532461 251436 365241 156243 426531 425613 426513 435126 632415 236541 364215 264531 624351 531462 153462 352164 325641 153264 642513 641523 351624 416325 246135 364521 652431 462531 136254 634251 256431 542631 561324 614532 165342 432516 263541 451326 562431 462351 315462 342561 645213 243615 314562 635421 624513 154263 421536 145362 461523 314652 521463 456231 251634 352614 145623 214635 431652 524136 512634 315246 326154 415236 146235 324165 516234 154362 265143 245613 251346 513462 256341 231645 452316 361452 456312 362415 214563 623451 362451 423516 135264 415632 436152 241356 243516 423165 614352 465132 241563 251364 153426 261345 265341 156342 136452 461253 465213 623145 234615 263415 526431 261543 463125 521634 364125 362514 624135 362154 563124 543612 523164 513642 362145 436125 436215 563241 513264 524163 614253 245361 432561 526413 415326 234516 346125 451632 261453 146325 614523 243165 236514 352461 254136 254163 634521 216453 325416 625314 156324 453216 324561 632514 461352 145632 613452 351426 342516 132564 152463 261534 253164 251463 623541 564312 326514 563142 263145 536241 356124 421653 352416 315426 324615 143652 463521 463512 561423 245136 453612 365124 546213 536214 643521 621453 346512 265431 456132 451236 462153 243651 412536 256314 435261 543621 524316 436512 532614 462315 423651 524361 214536 135624 134526 415362 365214 536412 315642 416352 352641 534261 314526 546132 425316 523146 364152 465123 465312 316425 631542 645123 345612 315264 264315 613542 642531 345261 241365 231654 236145 521643 254316 215643 634152 263451 253614 256134 135246 546123 423156 345126 534612 613425 561234 546312 134625 162453 415263 136245 536124 435162 526143 163542 542361 562341 235614 653412 153624 452631 452163 243156 146253 164253 421563 426135 145263 214653 352146 452361 531426 523461 136542 346215 261354 532416 253461 513426 512463 236451 463251 163425 543162 536421 345216 425163 423615 531624 643512 156432 354126 531642 256413 642315 325164 246531 651342 456321 645321 412563 342156 152364 134256 624531 453126 534621 465231 462513 452613 413562 326541 456123 142653 156423 135462 632541 432651 512364 "};
  // string sets[] = {"123",
  // 		   "2314 2134 1324 3124 1423 4123 1342 1234 1243 2341 ",
  // 		   "41352 15324 21354 32451 25314 52314 23154 15342 34215 23415 31254 42315 41253 13542 23145 24153 14253 42351 34512 31245 34152 24531 25134 24351 24135 23541 15243 15423 12435 13452 45123 51243 34251 42135 52134 21453 14523 13245 35124 23514 14352 21534 23451 51324 13254 15234 24513 13524 54123 12534 13425 32145 53124 51234 34125 12345 14235 12354 12453 21345 52341 51423 21435 25341 51342 32415 12543 34521 31452 43125 31524 31425 41325 14532 41235 14325 41523 24315 ",
  // 		   "341625 435216 235146 256143 621354 653124 253416 154632 453162 356412 623514 541263 523614 236154 531264 651324 561243 235416 524613 623415 615342 634215 631524 312564 124356 143562 514263 425361 624153 312645 632451 136524 534162 152634 126354 341265 265314 264153 351246 354621 264135 234651 342165 342651 356214 235461 413652 453261 142563 345162 321564 321645 562134 516324 324516 451623 143625 241653 321456 235164 326145 243561 263514 356421 165324 126453 521364 124635 431562 213546 123654 163452 124653 426315 412653 316245 231456 654123 142356 326451 354612 652341 124563 123564 421356 413526 125634 123546 514632 263154 361245 153642 152436 634512 234165 356241 345621 642351 514362 253146 453621 624315 235641 314625 316254 462135 351462 364251 612345 152643 635124 524631 342615 314265 543126 143526 124536 254613 125643 613254 354261 234561 142536 325146 324651 432156 521346 156234 234156 126435 341562 236415 526341 534216 324156 215346 254361 625341 562314 354216 164523 621435 634125 416235 246153 431526 136425 612453 512643 514623 261435 426351 231564 452136 642135 534126 451362 146532 326415 145326 146523 164235 143256 516243 532146 425631 341526 564123 361425 341652 135642 631245 124365 241635 245631 623154 164352 615423 165234 435612 134265 154623 351642 412635 312546 314256 125364 213645 523416 613524 516342 163524 451263 231546 361524 152346 246351 413256 631452 631425 164532 612543 341256 541623 356142 325461 154236 421635 641325 456213 542316 123645 423561 231465 134652 435621 346251 246513 413265 251643 142635 615234 325614 526134 361254 461235 162435 415623 431625 425136 146352 364512 346152 253641 215463 216354 354162 265134 614325 125463 213564 561342 162534 346521 523641 145236 134562 413625 461325 541362 526314 215634 351264 321546 264351 142365 213456 521436 154326 135426 245163 513624 254631 416253 241536 641253 412356 316524 416523 641352 165243 123456 652314 264513 215364 516423 246315 245316 625134 316452 315624 532461 251436 156243 425613 435126 632415 236541 364215 264531 624351 531462 153462 352164 325641 512436 153264 631254 641523 531246 351624 416325 246135 364521 136254 634251 256431 561324 614532 126534 214356 165342 432516 263541 451326 612435 462351 312456 315462 342561 652134 641235 621345 243615 314562 126345 312465 624513 154263 421536 145362 461523 615324 314652 521463 456231 251634 352614 145623 214635 524136 512634 315246 412365 214365 132456 415236 146235 324165 516234 154362 245613 251346 513462 132654 256341 231645 452316 361452 651234 456312 362415 214563 623451 362451 125436 423516 135264 415632 241356 243516 423165 614352 241563 251364 153426 261345 123465 265341 156342 541326 136452 461253 623145 234615 263415 463125 521634 364125 624135 512346 563124 132546 523164 513642 362145 436125 513264 524163 614253 245361 432561 415326 234516 346125 451632 261453 146325 312654 614523 216435 243165 236514 352461 254136 254163 634521 216453 325416 625314 156324 453216 324561 461352 145632 613452 351426 342516 132564 152463 261534 253164 251463 623541 431265 632145 263145 356124 352416 216534 324615 315426 143652 162354 561423 245136 453612 365124 621453 346512 456132 451236 243651 412536 153246 256314 435261 524316 612354 462315 542136 423651 524361 214536 213654 135624 134526 415362 541236 612534 315642 416352 615243 352641 534261 314526 425316 523146 364152 465123 316425 431256 215436 621534 645123 345612 315264 264315 613542 345261 241365 231654 216345 236145 254316 163245 215643 213465 634152 263451 253614 256134 135246 514236 546123 423156 345126 534612 613425 561234 134625 162453 643125 415263 136245 536124 435162 421365 163542 542361 562341 235614 153624 651243 452631 452163 243156 146253 132465 164253 421563 426135 145263 214653 352146 452361 531426 162345 523461 136542 346215 261354 532416 253461 513426 512463 236451 163425 345216 425163 423615 531624 156432 354126 164325 256413 642315 325164 246531 651342 514326 456321 321465 412563 342156 152364 134256 513246 132645 624531 453126 534621 452613 413562 126543 651423 613245 456123 142653 165423 163254 162543 125346 156423 135462 614235 143265 512364 "};
  int startk = 3;
  int endk = 6; // REQUIRE: endk - startk + 1 = |sets|
  int startn = 8;
  int endn = 11;
  vector < vector < double  > > runtimes (endk + 1, vector < double > (endn + 1, 0));
  vector < vector < uint64_t  > > stat1 (endk + 1, vector < uint64_t > (endn + 1));
  vector < vector < uint64_t  > > stat2 (endk + 1, vector < uint64_t > (endn + 1));
  vector < vector < uint64_t  > > stat3 (endk + 1, vector < uint64_t > (endn + 1));
  vector < vector < uint64_t  > > stat4 (endk + 1, vector < uint64_t > (endn + 1));

  vector < vector < double > > workperavoider  (endk + 1, vector < double > (endn + 1));
  vector < vector < double > > fractiononavoiders  (endk + 1, vector < double > (endn + 1));
  vector < vector < double > > specialratio  (endk + 1, vector < double > (endn + 1));
  vector < vector < double > > secspercheck  (endk + 1, vector < double > (endn + 1));
  vector < vector < double > > seqcheckratio  (endk + 1, vector < double > (endn + 1));
  
  
  for (int n = startn; n <= endn; n++) {
    for (int k = startk; k <= endk; k++) {
      runtimes[k][n] = run_interior_experiment(sets[k - startk], n);
      stat1[k][n] = getstat1();
      stat2[k][n] = getstat2();
      stat3[k][n] = getstat3();
      stat4[k][n] = getstat4();
      //cout<<stat1[k][n]<<" "<<stat2[k][n]<<" "<<stat3[k][n]<<endl;
      workperavoider[k][n] = (double)stat2[k][n] / (double)stat3[k][n];
      // workperavoider[k][n] = (double)stat2[k][n] / (double)stat3[k][n];
      //      fractiononavoiders[k][n] = (double)stat2[k][n] / (double)stat1[k][n]; //FOR BRUTE
      fractiononavoiders[k][n] = (double)stat4[k][n] / (double)stat2[k][n];
      //cout<<((double)stat2[k][n] / (double)Catalan(n))<<" "<<estimatedseqcheck(k, n)<<endl;
      //cout<<stat3[k][n]<<endl;
      // cout<<((double)stat2[k][n] / (double)prevnumwins)<<" at n = "<<n<<endl;
      // seqcheckratio[k][n] = ((double)stat2[k][n] / (double)prevnumwins) / (double)(allestimatedseqcheck(k, n)); // for brute all
      seqcheckratio[k][n] = ((double)runtimes[k][n] / (double)stat3[k][n]);
      //specialratio[k][n] = buildspecialratio(k, n, runtimes[k][n], runtimes[k][n - 1]);
      //secspercheck[k][n] = runtimes[k][n]/(double)stat4[k][n]; // FOR BRUTE
      secspercheck[k][n] = runtimes[k][n]/(double)stat2[k][n];
    }
  }
  buildtable(startk, startn, endk, endn, runtimes);
  buildtable(startk, startn, endk, endn, workperavoider);
  buildtable(startk, startn, endk, endn, fractiononavoiders);
  buildtable(startk, startn, endk, endn, seqcheckratio);
  
  buildtable(startk, startn, endk, endn, secspercheck);
}
